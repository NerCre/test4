<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <!-- アプリ名称を更新 -->
  <title>命をツナゲル</title>
  <link rel="stylesheet" href="style.css" />
  <!-- QrScanner library (for QR code scanning) -->
  <script src="https://unpkg.com/qr-scanner/qr-scanner.umd.min.js"></script>
</head>
<body>
  <div id="app" class="app">

    <!-- Top bar (shown except on Home) -->
    <header id="topbar" class="topbar" aria-label="操作バー">
      <button id="btnBack" class="icon-btn" type="button" aria-label="戻る">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.5 5.5 9 12l6.5 6.5-1.4 1.4L6.2 12l7.9-7.9 1.4 1.4z"/></svg>
        <span>戻る</span>
      </button>

      <!-- トップバーに表示するアプリ名称を更新 -->
      <div class="topbar-title" aria-hidden="true">命をツナゲル</div>

      <button id="btnRestartGlobal" class="icon-btn" type="button" aria-label="最初から">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17.65 6.35A7.95 7.95 0 0 0 12 4V1L7 6l5 5V7a6 6 0 1 1-6 6H4a8 8 0 1 0 13.65-6.65z"/></svg>
        <span>最初から</span>
      </button>
    </header>

    <main class="main">
      <!-- Home -->

      <section id="view-home" class="view active" aria-label="ホーム">
        <!-- Tunageruと同等のサイズ感に合わせたホーム（見た目のみ） -->
        <div class="hero">
          <div class="mascot">
            <!-- リンク画像と代替テキストを新しい名称に変更 -->
            <img src="ツナゲルくん.png" alt="ツナゲルくん" />
          </div>
          <!-- アプリタイトルを更新 -->
          <h1 class="app-title">命をツナゲル</h1>
        </div>

        <div class="button-container">
          <button id="btnStartEmergency" class="btn btn-emergency btn-emergency-main" type="button">
            緊急事態
            <div class="en">EMERGENCY</div>
          </button>
          <!-- New goods search button (物品を探す) -->
          <button id="btnGoodsSearch" class="btn btn-primary" type="button">
            物品を探す
            <div class="en">FIND GOODS</div>
          </button>
        </div>

        <div class="home-footer">
          <button id="btnAdmin" class="link-btn" type="button" aria-label="管理画面">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19.14,12.94c0.04-0.31 0.06-0.63 0.06-0.94 0-0.31-0.02-0.63-0.06-0.94l2.03-1.58c0.18-0.14 0.23-0.41 0.12-0.61l-1.92-3.32c-0.11-0.2-0.35-0.28-0.56-0.2l-2.39 0.96c-0.5-0.38-1.04-0.7-1.63-0.94L14.4,2.5C14.37,2.22 14.13,2 13.85,2h-3.7c-0.28,0-0.52,0.22-0.55,0.5L9.24,5.04c-0.59,0.24-1.13,0.56-1.63,0.94L5.22,5.02c-0.21-0.08-0.45,0-0.56,0.2L2.74,8.54c-0.11,0.2-0.06,0.46,0.12,0.61l2.03,1.58C4.85,11.04 4.83,11.36 4.83,11.67c0,0.31 0.02,0.63 0.06,0.94L2.86,14.19c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.11,0.2 0.35,0.28 0.56,0.2l2.39-0.96c0.5,0.38 1.04,0.7 1.63,0.94l0.36,2.54c0.03,0.28 0.27,0.5 0.55,0.5h3.7c0.28,0 0.52-0.22 0.55-0.5l0.36-2.54c0.59-0.24 1.13-0.56 1.63-0.94l2.39 0.96c0.21,0.08 0.45,0 0.56-0.2l1.92-3.32c0.11-0.2 0.06-0.46-0.12-0.61L19.14,12.94z M12,15.5c-1.93,0-3.5-1.57-3.5-3.5S10.07,8.5,12,8.5s3.5,1.57,3.5,3.5S13.93,15.5,12,15.5z"/></svg>
            <span>管理</span>
          </button>
          <p class="small-note">※ このアプリはスマホ縦向き利用を想定しています。</p>
        </div>
      </section>

      <!-- ===== Emergency guided flow (指示方式) ===== -->

      <!-- ===== One-page emergency input (1画面) ===== -->
      <!-- 新しいワンページ画面。すべての必要情報をスクロールで1画面内に入力できるように配置します -->
      <section id="view-onepage" class="view" aria-label="緊急入力">
        <h2>緊急入力</h2>

        <!-- 意識の有無 -->
        <div class="card">
          <div class="card-title">意識</div>
          <div class="seg" id="segConsciousOne" role="group" aria-label="意識の有無">
            <button class="seg-btn" type="button" data-val="yes">あり</button>
            <button class="seg-btn" type="button" data-val="no">なし</button>
            <button class="seg-btn" type="button" data-val="unknown">不明</button>
          </div>
        </div>

        <!-- 呼吸の有無 -->
        <div class="card">
          <div class="card-title">呼吸</div>
          <div class="seg" id="segBreathingOne" role="group" aria-label="呼吸の有無">
            <button class="seg-btn" type="button" data-val="yes">あり</button>
            <button class="seg-btn" type="button" data-val="no">なし</button>
            <button class="seg-btn" type="button" data-val="unknown">不明</button>
          </div>
        </div>

        <!-- 大量出血の有無 -->
        <div class="card">
          <div class="card-title">大量出血</div>
          <div class="seg" id="segBleedingOne" role="group" aria-label="大量出血の有無">
            <button class="seg-btn" type="button" data-val="yes">あり</button>
            <button class="seg-btn" type="button" data-val="no">なし</button>
            <button class="seg-btn" type="button" data-val="unknown">不明</button>
          </div>
        </div>

        <!-- 強い痛みの有無 -->
        <div class="card">
          <div class="card-title">強い痛み</div>
          <div class="seg" id="segPainOne" role="group" aria-label="強い痛みの有無">
            <button class="seg-btn" type="button" data-val="yes">あり</button>
            <button class="seg-btn" type="button" data-val="no">なし</button>
            <button class="seg-btn" type="button" data-val="unknown">不明</button>
          </div>
        </div>

        <!-- 場所選択 -->
        <div class="card">
          <div class="card-title">場所</div>
          <div class="form-row">
            <button id="btnScanLocationOne" class="btn btn-primary" type="button">場所QRを読む</button>
            <button id="btnMapSelectOne" class="btn btn-secondary" type="button">地図から選択</button>
          </div>
          <div class="helper-card" style="margin-top:8px;">
            <div class="helper-title">現在の場所</div>
            <div id="locationSelectedOne" class="helper-value">未選択</div>
          </div>
          <div class="form-col" style="margin-top:8px;">
            <label class="field">
              <span>手入力（未登録の場合）</span>
              <input id="locationManualOne" type="text" placeholder="例：第3ヤード 2号ドック付近" />
            </label>
            <button id="btnLocationSetManualOne" class="btn btn-secondary" type="button">手入力で設定</button>
            <button id="btnLocationUnknownOne" class="btn btn-secondary" type="button">不明</button>
          </div>
        </div>

        <!-- 事故区分 -->
        <div class="card">
          <div class="card-title">事故区分</div>
          <p class="small">当てはまるものを複数選択できます。</p>
          <div id="accidentIcons" class="icon-grid" aria-label="事故区分の選択"></div>
          <!-- 備考欄は削除しました -->
        </div>

        <!-- 被災者 -->
        <div class="card">
          <div class="card-title">被災者</div>
          <div class="form-row">
            <button id="btnScanVictimOne" class="btn btn-primary" type="button">ヘルメットQRを読む</button>
            <button id="btnSearchVictimOne" class="btn btn-secondary" type="button">氏名で探す</button>
          </div>
          <div class="helper-card" style="margin-top:8px;">
            <div class="helper-title">現在の被災者</div>
            <div id="victimSelectedOne" class="helper-value">未選択</div>
          </div>
        </div>

        <!-- アクションボタン（固定表示） -->
        <div class="footer-actions" id="onepage-actions">
          <div class="form-row">
            <!-- 最初はグレーアウト、状態に応じて色が変化します -->
        <!-- 救急車を呼ぶボタンは常に押せるようにする -->
        <button id="btnCallAmbulance" class="btn btn-emergency" type="button">救急車を呼ぶ</button>
            <button id="btnSendSms" class="btn btn-secondary" type="button">SMS発信</button>
          </div>
        </div>
      </section>

      <!-- ===== Goods search view (物品を探す) ===== -->
      <!-- ユーザーがAEDや担架などの物品を探すためのシンプルな選択画面 -->
      <section id="view-goods" class="view" aria-label="物品を探す">
        <h2>物品を探す</h2>
        <div class="button-container">
          <button id="btnGoodsAED" class="btn btn-primary" type="button">AED</button>
          <button id="btnGoodsStretcher" class="btn btn-primary" type="button">担架</button>
          <button id="btnGoodsOS1" class="btn btn-primary" type="button">OS1</button>
        </div>
      </section>

      <!-- ===== AED map view ===== -->
      <!-- AEDの位置を地図から選択する画面。全体図からエリア1～3を選択し、エリア図を表示します -->
      <section id="view-aed-map" class="view" aria-label="AEDマップ">
        <h2>AED</h2>
        <div class="aed-map-wrapper">
          <!-- Overview with interactive areas -->
          <div id="aed-overview" class="aed-overview">
            <div class="aed-map-container">
              <img src="map_aed_overview.png" alt="AED設置マップ全体" class="aed-map-img" />
              <!-- Equal sized overlay buttons dividing the map into three parts -->
              <button class="aed-area aed-area-1" data-area="1" type="button" aria-label="エリア1"></button>
              <button class="aed-area aed-area-2" data-area="2" type="button" aria-label="エリア2"></button>
              <button class="aed-area aed-area-3" data-area="3" type="button" aria-label="エリア3"></button>
            </div>
          </div>
          <!-- Detail area view (hidden until an area is selected) -->
          <div id="aed-detail" class="aed-detail hidden">
            <img id="aedDetailImg" src="" alt="AED設置エリア詳細" class="aed-map-img" />
          </div>
        </div>
        <div class="form-row" style="margin-top:12px;">
          <button id="btnAedBack" class="btn btn-secondary" type="button">閉じる</button>
        </div>
      </section>

      <!-- ===== Stretcher map view ===== -->
      <!-- 担架の位置を地図から選択する画面。全体図からエリア1～3を選択し、エリア図を表示します -->
      <section id="view-stretcher-map" class="view" aria-label="担架マップ">
        <h2>担架</h2>
        <div class="stretcher-map-wrapper">
          <!-- Overview with interactive areas -->
          <div id="stretcher-overview" class="stretcher-overview">
            <div class="stretcher-map-container">
              <img src="map_tanka_overview.png" alt="担架マップ全体" class="stretcher-map-img" />
              <!-- Equal sized overlay buttons dividing the map into three parts -->
              <button class="stretcher-area stretcher-area-1" data-area="1" type="button" aria-label="エリア1"></button>
              <button class="stretcher-area stretcher-area-2" data-area="2" type="button" aria-label="エリア2"></button>
              <button class="stretcher-area stretcher-area-3" data-area="3" type="button" aria-label="エリア3"></button>
            </div>
          </div>
          <!-- Detail area view (hidden until an area is selected) -->
          <div id="stretcher-detail" class="stretcher-detail hidden">
            <img id="stretcherDetailImg" src="" alt="担架エリア詳細" class="stretcher-map-img" />
          </div>
        </div>
        <div class="form-row" style="margin-top:12px;">
          <button id="btnStretcherBack" class="btn btn-secondary" type="button">閉じる</button>
        </div>
      </section>

      <!-- ===== OS-1 map view ===== -->
      <!-- OS-1 の位置を地図から選択する画面。全体図を3等分し、エリア1～3を選択するとエリア画像を表示します -->
      <section id="view-os1-map" class="view" aria-label="OS1マップ">
        <h2>OS-1</h2>
        <div class="os1-map-wrapper">
          <!-- Overview with interactive areas -->
          <div id="os1-overview" class="os1-overview">
            <div class="os1-map-container">
              <img src="map_os1_overview.png" alt="OS-1設置マップ全体" class="os1-map-img" />
              <!-- Equal sized overlay buttons dividing the map into three parts -->
              <button class="os1-area os1-area-1" data-area="1" type="button" aria-label="エリア1"></button>
              <button class="os1-area os1-area-2" data-area="2" type="button" aria-label="エリア2"></button>
              <button class="os1-area os1-area-3" data-area="3" type="button" aria-label="エリア3"></button>
            </div>
          </div>
          <!-- Detail area view (hidden until an area is selected) -->
          <div id="os1-detail" class="os1-detail hidden">
            <img id="os1DetailImg" src="" alt="OS-1設置エリア詳細" class="os1-map-img" />
          </div>
        </div>
        <div class="form-row" style="margin-top:12px;">
          <button id="btnOs1Back" class="btn btn-secondary" type="button">閉じる</button>
        </div>
      </section>
      <section id="view-triage" class="view" aria-label="意識と呼吸">
        <nav class="stepper" aria-label="手順">
          <button class="step-btn active" type="button" data-step="triage">① 意識/呼吸</button>
          <button class="step-btn" type="button" data-step="location">② 場所</button>
          <button class="step-btn" type="button" data-step="accident">③ 事故</button>
          <button class="step-btn" type="button" data-step="victim">④ 被災者</button>
          <button class="step-btn" type="button" data-step="review">⑤ 共有</button>
        </nav>

        <h2>① 意識と呼吸</h2>
        <p class="small">迷ったら「不明」で進められます（後から変更OK）。</p>

        <div class="card">
          <div class="card-title">意識</div>
          <div class="seg" id="segConscious" role="group" aria-label="意識の有無">
            <button class="seg-btn" type="button" data-val="yes">あり</button>
            <button class="seg-btn" type="button" data-val="no">なし</button>
            <button class="seg-btn" type="button" data-val="unknown">不明</button>
          </div>
        </div>

        <div class="card">
          <div class="card-title">呼吸</div>
          <div class="seg" id="segBreathing" role="group" aria-label="呼吸の有無">
            <button class="seg-btn" type="button" data-val="yes">あり</button>
            <button class="seg-btn" type="button" data-val="no">なし</button>
            <button class="seg-btn" type="button" data-val="unknown">不明</button>
          </div>
        </div>

        <div class="footer-actions">
          <button id="btnTriageNext" class="btn btn-primary" type="button" disabled>次へ</button>
          <button id="btnQuickToReview1" class="btn btn-secondary" type="button">未確定でも共有</button>
        </div>
      </section>

      <section id="view-location" class="view" aria-label="場所">
        <nav class="stepper" aria-label="手順">
          <button class="step-btn" type="button" data-step="triage">① 意識/呼吸</button>
          <button class="step-btn active" type="button" data-step="location">② 場所</button>
          <button class="step-btn" type="button" data-step="accident">③ 事故</button>
          <button class="step-btn" type="button" data-step="victim">④ 被災者</button>
          <button class="step-btn" type="button" data-step="review">⑤ 共有</button>
        </nav>

        <h2>② 場所（どこか）</h2>
        <div class="card">
          <div class="card-title">場所QR</div>
          <div class="form-row">
            <button id="btnScanLocation" class="btn btn-primary" type="button">場所QRを読む</button>
            <button id="btnMapSelect" class="btn btn-secondary" type="button">地図から選択</button>
          </div>
          <div class="small-note" id="locationScanHint">※ カメラが使えない場合は下で選択/入力できます。</div>
        </div>

        <div class="helper-card">
          <div class="helper-title">現在の場所</div>
          <div id="locationSelected" class="helper-value">未選択</div>
        </div>

        <div class="card">
          <div class="card-title">一覧から選ぶ</div>
          <div id="locationList" class="list" role="list"></div>
          <div class="form-col">
            <label class="field">
              <span>手入力（未登録の場合）</span>
              <input id="locationManual" type="text" placeholder="例：第3ヤード 2号ドック付近" />
            </label>
            <button id="btnLocationSetManual" class="btn btn-secondary" type="button">手入力で設定</button>
            <button id="btnLocationUnknown" class="btn btn-secondary" type="button">場所不明</button>
          </div>
        </div>

        <div class="footer-actions">
          <button id="btnLocationNext" class="btn btn-primary" type="button">次へ</button>
          <button id="btnQuickToReview2" class="btn btn-secondary" type="button">未確定でも共有</button>
        </div>
      </section>

      <section id="view-accident" class="view" aria-label="事故区分">
        <nav class="stepper" aria-label="手順">
          <button class="step-btn" type="button" data-step="triage">① 意識/呼吸</button>
          <button class="step-btn" type="button" data-step="location">② 場所</button>
          <button class="step-btn active" type="button" data-step="accident">③ 事故</button>
          <button class="step-btn" type="button" data-step="victim">④ 被災者</button>
          <button class="step-btn" type="button" data-step="review">⑤ 共有</button>
        </nav>

        <h2>③ 事故区分</h2>
        <p class="small">当てはまるものを複数選択できます。</p>
        <div id="accidentChips" class="chip-grid" aria-label="事故区分の選択"></div>
        <!-- 補足欄は削除しました -->

        <div class="footer-actions">
          <button id="btnAccidentNext" class="btn btn-primary" type="button">次へ</button>
          <button id="btnQuickToReview3" class="btn btn-secondary" type="button">未確定でも共有</button>
        </div>
      </section>

      <section id="view-victim" class="view" aria-label="被災者">
        <nav class="stepper" aria-label="手順">
          <button class="step-btn" type="button" data-step="triage">① 意識/呼吸</button>
          <button class="step-btn" type="button" data-step="location">② 場所</button>
          <button class="step-btn" type="button" data-step="accident">③ 事故</button>
          <button class="step-btn active" type="button" data-step="victim">④ 被災者</button>
          <button class="step-btn" type="button" data-step="review">⑤ 共有</button>
        </nav>

        <h2>④ 被災者（誰か）</h2>
        <div class="card">
          <div class="card-title">被災者QR</div>
          <button id="btnScanVictim" class="btn btn-primary" type="button">ヘルメットQRを読む</button>
          <div class="small-note">※ 読めない場合は下の検索で探せます。</div>
        </div>

        <div class="helper-card">
          <div class="helper-title">現在の被災者</div>
          <div id="victimSelected" class="helper-value">未選択</div>
        </div>

        <div class="card">
          <div class="card-title">氏名で探す</div>
          <input id="victimSearch" type="text" placeholder="よみ（かな）/ 氏名で検索" />
          <div id="victimList" class="list" role="list"></div>
          <button id="btnVictimUnknown" class="btn btn-secondary" type="button">不明</button>
        </div>

        <div class="footer-actions">
          <button id="btnVictimNext" class="btn btn-primary" type="button">次へ</button>
          <button id="btnQuickToReview4" class="btn btn-secondary" type="button">未確定でも共有</button>
        </div>
      </section>

      <section id="view-review" class="view" aria-label="共有">
        <nav class="stepper" aria-label="手順">
          <button class="step-btn" type="button" data-step="triage">① 意識/呼吸</button>
          <button class="step-btn" type="button" data-step="location">② 場所</button>
          <button class="step-btn" type="button" data-step="accident">③ 事故</button>
          <button class="step-btn" type="button" data-step="victim">④ 被災者</button>
          <button class="step-btn active" type="button" data-step="review">⑤ 共有</button>
        </nav>

        <h2>⑤ 共有（未確定でもOK）</h2>
        <div class="card">
          <div class="card-title">要約</div>
          <div id="reviewSummary" class="summary"></div>
        </div>

        <div class="card">
          <div class="card-title">送信先</div>
          <div id="reviewRecipients" class="small"></div>
          <div class="small-note">※ 送信先範囲は「管理＞連絡先」で変更できます。</div>
        </div>

        <div class="footer-actions">
          <button id="btnWizardOpenMail" class="btn btn-primary" type="button">メールを開く</button>
          <button id="btnWizardCopy" class="btn btn-secondary" type="button">内容をコピー</button>
        </div>
      </section>

      <!-- QR modal (camera + manual) -->
      <div id="qrModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="QR読み込み">
        <div class="modal-card">
          <div class="modal-head">
            <div id="qrModalTitle" class="modal-title">QRを読み取ってください</div>
            <button id="btnQrClose" class="icon-btn" type="button" aria-label="閉じる">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3 1.4 1.4z"/></svg>
            </button>
          </div>

          <div class="modal-body">
            <div id="qrCameraWrap" class="qr-camera">
              <video id="qrVideo" playsinline muted autoplay></video>
              <div class="qr-overlay" aria-hidden="true">
                <div class="qr-frame"></div>
              </div>
              <div class="small">※ カメラが許可されない／起動できない場合は、下の「写真で読み取る」または貼り付けで対応できます。</div>
            </div>

            <!-- Fallback: capture photo (works even when getUserMedia is unavailable) -->
            <div class="qr-fallback">
              <input id="qrFile" type="file" accept="image/*" capture="environment" class="hidden" />
              <button id="btnQrPhoto" class="btn btn-secondary" type="button">写真で読み取る</button>
              <div class="small-note">※ 「写真で読み取る」は、端末がカメラのライブ表示に対応していない場合の代替手段です。</div>
            </div>

            <label class="field">
              <span>QRの文字列（貼り付け/手入力）</span>
              <input id="qrManual" type="text" placeholder="QRの内容" />
            </label>
            <button id="btnQrUseManual" class="btn btn-primary" type="button">この内容を使う</button>

            <div id="qrStatus" class="small" style="margin-top:8px;"></div>

            <div class="modal-actions">
              <button id="btnQrCancel" class="btn btn-secondary" type="button">キャンセル</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Map modal (select location) -->
      <div id="mapModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="地図から場所を選択">
        <div class="modal-card modal-card-wide">
          <div class="modal-head">
            <div class="modal-title">地図から場所を選択</div>
            <button id="btnMapClose" class="icon-btn" type="button" aria-label="閉じる">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3 1.4 1.4z"/></svg>
            </button>
          </div>

          <div class="modal-body">
            <p class="small" style="margin-top:0;">QRが読めない／近くにない場合は、地図タップまたは一覧検索で場所名を入力できます。</p>

            <div class="map-stage" aria-label="地図">
              <div class="map-stage-actions" aria-label="表示切替">
                <div class="map-tabs" role="tablist" aria-label="エリア切替">
                  <button id="btnMapViewAll" class="map-tab active" type="button" role="tab" aria-selected="true">全体</button>
                  <button id="btnMapViewA1" class="map-tab" type="button" role="tab" aria-selected="false">エリア1</button>
                  <button id="btnMapViewA2" class="map-tab" type="button" role="tab" aria-selected="false">エリア2</button>
                  <button id="btnMapViewA3" class="map-tab" type="button" role="tab" aria-selected="false">エリア3</button>
                </div>
                <button id="btnMapResetZoom" class="btn btn-secondary" type="button">全体に戻る</button>
              </div>

              <div class="map-stage-inner">
                <!-- SVG that renders the background image + polygons in the SAME coordinate space (prevents drift). -->
                <svg id="yardSvg" class="yard-svg" viewBox="0 0 3307 2339" preserveAspectRatio="xMidYMid meet" aria-label="ヤード地図"></svg>
              </div>

              <div id="mapPickHint" class="small" style="margin-top:8px;">
                ① まずは「全体」でエリアを選択（または上のタブ） → ② 拡大表示で区画をタップして確定できます。
                <br>※ タップ位置に近い候補も出るので、間違いそうな時は候補から選び直してください。
              </div>

              <div class="map-cand-wrap" aria-label="近い候補" style="margin-top:8px;">
                <div class="small" style="margin-bottom:6px; opacity:.9;">タップ位置の近い候補：</div>
                <div id="mapCandidates" class="map-candidates"></div>
              </div>
            </div>


            <div class="map-tools">
              <input id="mapSearch" type="text" placeholder="場所名で検索（例：A棟、DOCK、南定盤）" />
              <div class="map-tool-actions">
                <button id="btnMapClear" class="btn btn-secondary" type="button">クリア</button>
              </div>
            </div>

            <div id="mapList" class="map-list" role="list" aria-label="場所一覧"></div>

            <div class="helper-card" style="margin-top:12px;">
              <div class="helper-title">選択中</div>
              <div id="mapSelectedLabel" class="helper-value">未選択</div>
            </div>

            <div class="modal-actions">
              <div class="form-row">
                <button id="btnMapUse" class="btn btn-primary" type="button" disabled>この場所を使う</button>
                <button id="btnMapCancel" class="btn btn-secondary" type="button">キャンセル</button>
              </div>
              <p class="small" style="margin:10px 0 0; opacity:.85;">※ GitHub Pages / ローカルHTMLでも動くように、外部通信は行いません。</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Victim search modal (氏名で探す) -->
      <div id="victimModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="氏名で探す">
        <div class="modal-card modal-card-wide">
          <div class="modal-head">
            <div class="modal-title">氏名で探す</div>
            <button id="btnVictimClose" class="icon-btn" type="button" aria-label="閉じる">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3l6.3 6.3 6.3-6.3 1.4 1.4z"/></svg>
            </button>
          </div>
          <div class="modal-body">
            <input id="victimSearchModal" type="text" placeholder="よみ（かな）/ 氏名で検索" />
            <div id="victimListModal" class="list" role="list"></div>
            <button id="btnVictimUnknownModal" class="btn btn-secondary" type="button" style="margin-top:8px;">不明</button>
          </div>
        </div>
      </div>
<!-- Status select -->
      <section id="view-status" class="view" aria-label="状況選択">
        <h2>状況を選択してください</h2>
        <div id="statusGrid" class="grid" role="list"></div>
        <p class="small">※ 状況と所属に応じて、連絡先・文面を自動作成します。</p>
      </section>

      <!-- Company select -->
      <section id="view-company" class="view" aria-label="所属選択">
        <h2>所属を選択してください</h2>
        <div id="companyList" class="list" role="list"></div>
      </section>

      <!-- Person select -->
      <section id="view-person" class="view" aria-label="対象者選択">
        <h2>誰が（対象者）</h2>
        <div id="kanaBar" class="kana-bar" aria-label="読みで絞り込み"></div>
        <div id="personList" class="list" role="list"></div>
        <p class="small">※ 手入力せずに探せるよう、読み（かな）で絞り込みます。</p>
      </section>

      <!-- Body part select (for pain/bleeding) -->
      <section id="view-body" class="view" aria-label="部位選択">
        <h2 id="bodyTitle">部位を選択してください</h2>
        <p id="bodyQuestion" class="question">出血・痛みの部位をタップしてください。</p>

        <div id="bodyWrap" class="body-wrap">
          <svg id="bodySvg" viewBox="0 0 220 520" aria-label="人体シルエット">
            <!-- head -->
            <circle cx="110" cy="55" r="32" class="body-part" data-part="head" />
            <!-- neck -->
            <rect x="98" y="87" width="24" height="18" rx="10" class="body-part" data-part="neck" />
            <!-- torso -->
            <rect x="70" y="105" width="80" height="130" rx="26" class="body-part" data-part="torso" />
            <!-- left arm -->
            <rect x="30" y="125" width="34" height="120" rx="16" class="body-part" data-part="leftArm" />
            <!-- right arm -->
            <rect x="156" y="125" width="34" height="120" rx="16" class="body-part" data-part="rightArm" />
            <!-- left hand -->
            <rect x="26" y="245" width="42" height="38" rx="14" class="body-part" data-part="leftHand" />
            <!-- right hand -->
            <rect x="152" y="245" width="42" height="38" rx="14" class="body-part" data-part="rightHand" />
            <!-- hips -->
            <rect x="74" y="235" width="72" height="48" rx="18" class="body-part" data-part="hips" />
            <!-- left leg -->
            <rect x="78" y="285" width="34" height="150" rx="16" class="body-part" data-part="leftLeg" />
            <!-- right leg -->
            <rect x="108" y="285" width="34" height="150" rx="16" class="body-part" data-part="rightLeg" />
            <!-- left foot -->
            <rect x="72" y="435" width="44" height="34" rx="14" class="body-part" data-part="leftFoot" />
            <!-- right foot -->
            <rect x="104" y="435" width="44" height="34" rx="14" class="body-part" data-part="rightFoot" />
          </svg>
        </div>

        <div class="helper-card">
          <div class="helper-title">選択中</div>
          <div id="bodySelectedLabel" class="helper-value">未選択</div>
        </div>

        <div class="footer-actions">
          <button id="btnBodyNext" class="btn btn-primary" type="button" disabled>
            次へ
          </button>
        </div>
      </section>

      <!-- Result -->
      
  <section id="view-emergency" class="view" aria-label="救急要請中">
    <h2 class="view-title">救急要請</h2>

    <div class="call-wrap" role="status" aria-live="polite">
      <div class="call-circle">
        <div class="call-icon" aria-hidden="true">🚑</div>
        <div class="call-text">救急要請中</div>
        <div class="call-sub small">（デモ：実際の救急要請は行いません）</div>
      </div>
    </div>

    <div class="actions">
      <button id="btnOpenMailEmergency" type="button" class="btn btn-primary">
        メールアプリを開く
      </button>
    </div>

    <p class="small muted">
      ※ 送信内容のプレビューは表示しません（緊急事態の想定）。
    </p>
  </section>

<section id="view-result" class="view" aria-label="判断結果">
        <h2>判断結果</h2>

        <div class="summary-card">
          <div class="summary-row"><span>状況</span><strong id="sumStatus">-</strong></div>
          <div class="summary-row"><span>所属</span><strong id="sumCompany">-</strong></div>
          <div class="summary-row"><span>対象者</span><strong id="sumPerson">-</strong></div>
          <div class="summary-row" id="sumDetailRow"><span>詳細</span><strong id="sumDetail">-</strong></div>
        </div>

        <div class="result-card">
          <p id="resultText" class="result-message"></p>
        </div>

        <div class="result-actions">
          <button id="btnActionEmergency" class="btn btn-emergency" type="button">
            緊急要請する
          </button>
          <button id="btnActionObserve" class="btn btn-secondary" type="button">
            様子を見る
          </button>
        </div>

        <div class="mail-preview">
          <div class="mail-preview-title">送信内容（プレビュー）</div>
          <div class="mail-preview-row"><span>宛先</span><div id="mailToPreview" class="mono">-</div></div>
          <div class="mail-preview-row"><span>件名</span><div id="mailSubjectPreview" class="mono">-</div></div>
          <div class="mail-preview-row"><span>本文</span><pre id="mailBodyPreview" class="mono pre">-</pre></div>

          <div class="mail-preview-actions">
            <button id="btnOpenMail" class="btn btn-primary" type="button">メールアプリを開く</button>
            <button id="btnCopyMail" class="btn btn-secondary" type="button">コピー</button>
          </div>

          <p class="small">
            ※ ブラウザから自動送信はできないため、メールアプリに文面を引き継ぎます（mailto）。
          </p>
        </div>
      </section>

      <!-- Admin -->
      <section id="view-admin" class="view" aria-label="管理画面">
        <h2>管理画面</h2>

        <div id="adminGate" class="admin-gate">
          <p class="small">パスワードで保護されています。</p>

          <div id="adminFirstSet" class="card hidden">
            <div class="card-title">初回設定</div>
            <label class="field">
              <span>新しいパスワード</span>
              <input id="adminNewPass1" type="password" autocomplete="new-password" />
            </label>
            <label class="field">
              <span>確認</span>
              <input id="adminNewPass2" type="password" autocomplete="new-password" />
            </label>
            <button id="btnAdminSetPass" class="btn btn-primary" type="button">設定する</button>
          </div>

          <div id="adminLogin" class="card hidden">
            <div class="card-title">ログイン</div>
            <label class="field">
              <span>パスワード</span>
              <input id="adminPass" type="password" autocomplete="current-password" />
            </label>
            <button id="btnAdminLogin" class="btn btn-primary" type="button">ログイン</button>
          </div>

          <p id="adminGateMsg" class="small"></p>
        </div>

        <div id="adminPanel" class="hidden">
          <div class="admin-tabs" role="tablist" aria-label="管理タブ">
            <button class="tab active" data-tab="companies" type="button">会社</button>
            <button class="tab" data-tab="staff" type="button">職員</button>
            <button class="tab" data-tab="locations" type="button">場所</button>
            <button class="tab" data-tab="messages" type="button">文面</button>
            <button class="tab" data-tab="export" type="button">入出力</button>
          </div>

          <!-- Companies -->
          <section class="admin-tab active" data-tab-panel="companies">
            <div class="card">
              <div class="card-title">会社（所属）</div>
              <div id="adminCompanies" class="admin-list"></div>

              <div class="divider"></div>
              <div class="card-subtitle">追加</div>
              <div class="form-row">
                <input id="newCompanyName" type="text" placeholder="会社名（例：自社）" />
                <input id="newCompanyEmails" type="text" placeholder="送信先メール（カンマ区切り）" />
                <button id="btnAddCompany" class="btn btn-primary" type="button">追加</button>
              </div>
            </div>

            <div class="card">
              <div class="card-title">共通連絡先（部署等）</div>
              <div class="form-col">
                <label class="field">
                  <span>安全課本部</span>
                  <input id="gcSafetyHQ" type="text" placeholder="safety@example.com" />
                </label>
                <label class="field">
                  <span>現場救護班</span>
                  <input id="gcRescueTeam" type="text" placeholder="rescue@example.com" />
                </label>
                <label class="field">
                  <span>救急指令センター</span>
                  <input id="gcAmbulance" type="text" placeholder="dispatch@example.com" />
                </label>

                <div class="divider"></div>
                <div class="card-subtitle">送信先範囲（チェック）</div>
                <label class="check">
                  <input id="scopeSafetyHQ" type="checkbox" />
                  <span>安全課本部</span>
                </label>
                <label class="check">
                  <input id="scopeRescueTeam" type="checkbox" />
                  <span>現場救護班</span>
                </label>
                <label class="check">
                  <input id="scopeAmbulance" type="checkbox" />
                  <span>救急指令センター</span>
                </label>
                <label class="check">
                  <input id="scopeCompanyEmails" type="checkbox" />
                  <span>会社（所属）の送信先も含める</span>
                </label>

                <button id="btnSaveGlobalContacts" class="btn btn-primary" type="button">保存</button>
              </div>
            </div>
          </section>

          <!-- Staff -->
          <section class="admin-tab" data-tab-panel="staff">
            <div class="card">
              <div class="card-title">職員（対象者）</div>
              <div class="form-row">
                <select id="staffCompanyFilter"></select>
                <button id="btnStaffFilter" class="btn btn-secondary" type="button">表示</button>
              </div>
              <div id="adminStaff" class="admin-list"></div>

              <div class="divider"></div>
              <div class="card-subtitle">追加</div>
              <div class="form-grid">
                <select id="newStaffCompany"></select>
                <input id="newStaffName" type="text" placeholder="氏名（例：山田 太郎）" />
                <input id="newStaffKana" type="text" placeholder="よみ（かな/カナ 例：やまだたろう）" />
                <input id="newStaffQr" type="text" placeholder="ヘルメットQR（任意）" />
                <button id="btnAddStaff" class="btn btn-primary" type="button">追加</button>
              </div>
            </div>
          </section>

          <!-- Locations -->
          <section class="admin-tab" data-tab-panel="locations">
            <div class="card">
              <div class="card-title">場所（QR対応）</div>
              <p class="small">周囲のQRから「どこか」を即時特定するための一覧です。QRの内容（文字列）を登録してください。</p>
              <div id="adminLocations" class="admin-list"></div>

              <div class="divider"></div>
              <div class="card-subtitle">追加</div>
              <div class="form-grid">
                <input id="newLocName" type="text" placeholder="場所名（例：第3ヤード 2号ドック）" />
                <input id="newLocQr" type="text" placeholder="場所QRの内容（文字列）" />
                <button id="btnAddLoc" class="btn btn-primary" type="button">追加</button>
              </div>
            </div>
          </section>

          <!-- Messages -->
          <section class="admin-tab" data-tab-panel="messages">
            <div class="card">
              <div class="card-title">状況と文面</div>
              <p class="small">状況ごとに「推奨表示文」や、緊急/様子見の送信先（部署）を調整できます。</p>
              <div id="adminSituations" class="admin-list"></div>
            </div>

            <div class="card">
              <div class="card-title">パスワード変更</div>
              <div class="form-grid">
                <input id="adminChangeOld" type="password" placeholder="現在のパスワード" />
                <input id="adminChangeNew1" type="password" placeholder="新しいパスワード" />
                <input id="adminChangeNew2" type="password" placeholder="確認" />
                <button id="btnAdminChangePass" class="btn btn-primary" type="button">変更</button>
              </div>
              <p id="adminChangeMsg" class="small"></p>
            </div>
          </section>

          <!-- Export/Import -->
          <section class="admin-tab" data-tab-panel="export">
            <div class="card">
              <div class="card-title">設定の入出力</div>
              <div class="form-row">
                <button id="btnExportJson" class="btn btn-primary" type="button">設定をJSONで書き出し</button>
                <label class="btn btn-secondary file-btn" for="importJson">
                  JSONを読み込み
                </label>
                <input id="importJson" type="file" accept="application/json" />
              </div>
              <p class="small">※ 端末内（localStorage）に保存されます。共有したい場合はJSONを書き出してください。</p>
              <p id="adminIoMsg" class="small"></p>
            </div>
          </section>

        </div>
      </section>

      <!-- Toast -->
      <div id="toast" class="toast" role="status" aria-live="polite"></div>
    </main>

  <!-- ====================================================
       グローバルオーバーレイ
       緊急時の誘導や確認ダイアログを表示するためのモーダル
       常に最上位に位置し、背景をぼかして操作を中断します
    ==================================================== -->
  <div id="overlay" class="overlay hidden" role="dialog" aria-modal="true">
    <div class="overlay-content">
      <!-- 右上に配置する閉じるボタン。誤操作が起きにくいよう適度なサイズの×ボタンを設置 -->
      <button id="overlay-close" class="overlay-close" type="button" aria-label="閉じる">×</button>
      <p id="overlay-message"></p>
      <div id="overlay-buttons" class="overlay-buttons"></div>
    </div>
  </div>
  </div>

  <script src="script.js"></script>
</body>
</html>
